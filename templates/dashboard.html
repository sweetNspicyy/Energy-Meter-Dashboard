<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans pb-10 overflow-x-hidden">

    <div id="sim-sidebar" class="fixed inset-y-0 left-0 w-80 bg-slate-950 border-r border-purple-500/30 transform -translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col shadow-2xl">
        <div class="p-6 border-b border-white/10 bg-purple-900/10">
            <div class="flex justify-between items-center">
                <h3 class="text-purple-400 font-bold uppercase text-sm tracking-widest"><i class="fas fa-flask mr-2"></i> Simulator</h3>
                <button onclick="toggleSimulation()" class="text-slate-400 hover:text-white transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
        </div>
        <div class="p-6 flex-1 overflow-y-auto space-y-6">
            <div class="group">
                <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">Target Daily Energy (kWh)</label>
                <div class="relative">
                    <input type="number" id="sim-kwh" value="15" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 pl-10 text-white focus:border-purple-500 font-mono transition-all">
                    <i class="fas fa-bolt absolute left-3 top-3.5 text-slate-500"></i>
                </div>
            </div>
            <div class="group">
                <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">Electricity Rate (PHP/kWh)</label>
                <div class="relative">
                    <input type="number" id="sim-rate" value="11.60" step="0.01" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 pl-10 text-white focus:border-purple-500 font-mono transition-all">
                    <i class="fas fa-coins absolute left-3 top-3.5 text-slate-500"></i>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">Presets</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="presetSim('low')" class="bg-slate-900 hover:bg-green-900/20 border border-slate-700 hover:border-green-500/50 text-xs py-3 rounded-lg transition-all flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-leaf text-green-500"></i> <span>Efficient</span>
                    </button>
                    <button onclick="presetSim('high')" class="bg-slate-900 hover:bg-red-900/20 border border-slate-700 hover:border-red-500/50 text-xs py-3 rounded-lg transition-all flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-fire text-red-500"></i> <span>High Load</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="p-6 border-t border-white/10 bg-slate-950">
            <button onclick="runSimulation()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg shadow-lg transition-all">
                Update Dashboard
            </button>
        </div>
    </div>

    <div id="main-content" class="transition-all duration-300 ease-in-out">
        <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0"><i class="fas fa-bolt text-blue-500 text-2xl animate-pulse"></i></div>
                        <div class="ml-4">
                            <h1 class="text-xl font-bold tracking-tight">Energy Meter Dashboard</h1>
                            <div class="flex items-center space-x-2 text-xs text-slate-400 uppercase tracking-wider font-mono mt-1">
                                <p id="date-display">Loading Date...</p>
                                <span class="text-slate-600">|</span>
                                <p id="time-display" class="text-blue-400 font-bold">--:--:--</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleSimulation()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center border border-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.4)]"><i class="fas fa-sliders-h mr-2"></i> Simulator</button>
                        <div class="hidden md:flex ml-4 space-x-2 bg-slate-900 p-1 rounded-lg">
                            <button onclick="setPeriod('today')" id="btn-today" class="filter-btn px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white transition-all">Today</button>
                            <button onclick="setPeriod('weekly')" id="btn-weekly" class="filter-btn px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white transition-all">Weekly</button>
                            <button onclick="setPeriod('monthly')" id="btn-monthly" class="filter-btn px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white transition-all">Monthly</button>
                            <button onclick="setPeriod('yearly')" id="btn-yearly" class="filter-btn px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white transition-all">Yearly</button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-6 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-slate-800 rounded-xl p-6 shadow-lg border-l-4 border-yellow-400 has-tooltip relative">
                    <div class="flex justify-between items-start">
                        <h2 class="text-slate-400 text-xs font-bold uppercase">Voltage <i class="fas fa-question-circle ml-1 text-slate-600 hover:text-white"></i></h2>
                    </div>
                    <div class="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 w-48 bg-black/90 text-white text-xs p-2 rounded shadow-xl z-50 pointer-events-none border border-slate-700">Electrical pressure. Standard PH outlet is 220V-230V.</div>
                    <p class="mt-2 text-3xl font-bold font-mono"><span id="val-voltage">220.0</span> <span class="text-sm text-slate-500">V</span></p>
                </div>
                <div class="bg-slate-800 rounded-xl p-6 shadow-lg border-l-4 border-green-400 has-tooltip relative">
                    <div class="flex justify-between items-start">
                        <h2 class="text-slate-400 text-xs font-bold uppercase">Current <i class="fas fa-question-circle ml-1 text-slate-600 hover:text-white"></i></h2>
                    </div>
                    <div class="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 w-48 bg-black/90 text-white text-xs p-2 rounded shadow-xl z-50 pointer-events-none border border-slate-700">The flow of electricity. Higher amps means more active appliances.</div>
                    <p class="mt-2 text-3xl font-bold font-mono"><span id="val-current">0.00</span> <span class="text-sm text-slate-500">A</span></p>
                </div>
                <div class="bg-slate-800 rounded-xl p-6 shadow-lg border-l-4 border-red-500 has-tooltip relative">
                    <div class="flex justify-between items-start">
                        <h2 class="text-slate-400 text-xs font-bold uppercase">Power <i class="fas fa-question-circle ml-1 text-slate-600 hover:text-white"></i></h2>
                    </div>
                    <div class="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 w-48 bg-black/90 text-white text-xs p-2 rounded shadow-xl z-50 pointer-events-none border border-slate-700">Real-time energy consumption (Watts). This is what you pay for.</div>
                    <p class="mt-2 text-3xl font-bold font-mono"><span id="val-power">0.0</span> <span class="text-sm text-slate-500">W</span></p>
                </div>
                <div class="bg-slate-800 rounded-xl p-6 shadow-lg border-l-4 border-blue-500 has-tooltip relative">
                    <div class="flex justify-between items-start">
                        <h2 class="text-slate-400 text-xs font-bold uppercase">Rate / Hour <i class="fas fa-question-circle ml-1 text-slate-600 hover:text-white"></i></h2>
                    </div>
                    <div class="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 w-48 bg-black/90 text-white text-xs p-2 rounded shadow-xl z-50 pointer-events-none border border-slate-700">Estimated cost per hour based on current usage and ₱11.60 rate.</div>
                    <p class="mt-2 text-3xl font-bold font-mono">₱<span id="val-live-cost">0.00</span></p>
                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 relative">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 id="chart-title" class="text-lg font-bold text-white">Today's Power Usage</h3>
                        <p class="text-xs text-slate-400">Consumption trends</p>
                    </div>
                    <div id="status-badge" class="bg-slate-700 px-3 py-1 rounded text-xs text-slate-300">
                        <i class="fas fa-circle text-green-400 text-[8px] mr-1 animate-pulse"></i> Online
                    </div>
                </div>
                <div class="relative h-80 w-full">
                    <canvas id="mainChart"></canvas>
                </div>
                <div id="sim-indicator" class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 bg-purple-600/90 text-white px-4 py-1 rounded-full text-xs font-bold shadow-lg backdrop-blur-sm">SIMULATION ACTIVE</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700 has-tooltip relative">
                    <div class="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 w-48 bg-black/90 text-white text-xs p-2 rounded shadow-xl z-50 pointer-events-none border border-slate-700">Total projected energy consumption (kWh).</div>
                    <h4 class="text-slate-400 text-xs font-bold uppercase"><span id="label-kwh">Total Energy</span> <i class="fas fa-question-circle ml-1 text-slate-600 hover:text-white"></i></h4>
                    <div class="mt-4 flex items-baseline"><span id="val-kwh" class="text-4xl font-bold text-white">--</span><span class="ml-2 text-sm text-purple-400">kWh</span></div>
                </div>
                <div class="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700 has-tooltip relative">
                    <div class="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 w-48 bg-black/90 text-white text-xs p-2 rounded shadow-xl z-50 pointer-events-none border border-slate-700">Total estimated bill (Pesos) for the selected period.</div>
                    <h4 class="text-slate-400 text-xs font-bold uppercase"><span id="label-cost">Total Cost</span> <i class="fas fa-question-circle ml-1 text-slate-600 hover:text-white"></i></h4>
                    <div class="mt-4 flex items-baseline"><span class="text-2xl text-slate-400 mr-1">₱</span><span id="val-total-cost" class="text-4xl font-bold text-white">--</span></div>
                </div>
                <div class="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700 has-tooltip relative">
                    <div class="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 w-48 bg-black/90 text-white text-xs p-2 rounded shadow-xl z-50 pointer-events-none border border-slate-700">Estimated environmental impact based on PH grid.</div>
                    <h4 class="text-slate-400 text-xs font-bold uppercase">Carbon Footprint <i class="fas fa-question-circle ml-1 text-slate-600 hover:text-white"></i></h4>
                    <div class="mt-4 flex items-baseline"><span id="val-carbon" class="text-4xl font-bold text-white">--</span><span class="ml-2 text-sm text-green-400">kgCO₂</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPeriod = 'today';
        let isSimulation = false;
        let simAvgPower = 0; // NEW: Stores the simulated power level
        const BASE_RATE = 11.60; 

        // DATE & TIME
        function updateDateTime() {
            const now = new Date();
            document.getElementById('date-display').innerText = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('time-display').innerText = now.toLocaleTimeString('en-US', { hour12: true });
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // CHART
        const ctx = document.getElementById('mainChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); 
        gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)'); 

        const myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Power (Watts)', data: [], borderColor: '#3b82f6', backgroundColor: gradient, borderWidth: 2, tension: 0.4, fill: true, pointRadius: 3 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { display: false } } }
        });

        // TOGGLE
        function toggleSimulation() {
            const sidebar = document.getElementById('sim-sidebar');
            const mainContent = document.getElementById('main-content');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                mainContent.style.marginLeft = "20rem"; 
                isSimulation = true;
                document.getElementById('sim-indicator').classList.remove('hidden');
                document.getElementById('status-badge').innerHTML = '<i class="fas fa-flask text-purple-400 text-[8px] mr-1 animate-pulse"></i> Simulation';
                document.getElementById('status-badge').className = "bg-purple-900/30 border border-purple-500/50 px-3 py-1 rounded text-xs text-purple-300";
                runSimulation();
            } else {
                sidebar.classList.add('-translate-x-full');
                mainContent.style.marginLeft = "0";
                isSimulation = false;
                document.getElementById('sim-indicator').classList.add('hidden');
                document.getElementById('status-badge').innerHTML = '<i class="fas fa-circle text-green-400 text-[8px] mr-1 animate-pulse"></i> Online';
                document.getElementById('status-badge').className = "bg-slate-700 px-3 py-1 rounded text-xs text-slate-300";
                fetchHistory();
            }
        }

        function presetSim(type) {
            document.getElementById('sim-kwh').value = (type === 'low') ? 5 : 45;
            runSimulation();
        }

        function runSimulation() {
            if(!isSimulation) return;
            const targetKwh = parseFloat(document.getElementById('sim-kwh').value) || 15;
            const rate = parseFloat(document.getElementById('sim-rate').value) || 11.60;
            
            // Calculate Sim Average Power for Live Gauges
            // (kWh * 1000) / 24 hours = Watts
            simAvgPower = (targetKwh * 1000) / 24;

            let simLabels = [], simValues = [], totalMultiplier = 1;

            if (currentPeriod === 'today') {
                simLabels = Array.from({length: 24}, (_, i) => `${i}:00`);
                const baseProfile = [1,1,1,1,1,2, 4,6,8,7,4,3, 3,3,3,3,4,6, 9,10,9,8,6,3]; 
                const sumProfile = baseProfile.reduce((a,b)=>a+b,0);
                const totalWatts = targetKwh * 1000;
                simValues = baseProfile.map(v => (v / sumProfile) * totalWatts);
                totalMultiplier = 1;
            } else if (currentPeriod === 'weekly') {
                simLabels = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
                const avgDaily = (targetKwh * 1000) / 24;
                simValues = Array(7).fill(0).map(() => avgDaily * (0.9 + Math.random()*0.2));
                totalMultiplier = 7;
            } else if (currentPeriod === 'monthly') {
                simLabels = Array.from({length: 30}, (_, i) => `Day ${i+1}`);
                const avgDaily = (targetKwh * 1000) / 24;
                simValues = Array(30).fill(0).map(() => avgDaily * (0.8 + Math.random()*0.4));
                totalMultiplier = 30;
            } else {
                simLabels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const avgDaily = (targetKwh * 1000) / 24;
                simValues = Array(12).fill(0).map(() => avgDaily * (0.8 + Math.random()*0.4));
                totalMultiplier = 365;
            }

            myChart.data.labels = simLabels;
            myChart.data.datasets[0].data = simValues;
            myChart.data.datasets[0].borderColor = '#9333ea'; 
            myChart.data.datasets[0].backgroundColor = 'rgba(147, 51, 234, 0.2)';
            myChart.update();

            const simTotalKwh = (targetKwh * totalMultiplier).toFixed(2);
            const simTotalCost = (simTotalKwh * rate).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const simCarbon = (simTotalKwh * 0.702).toFixed(2);

            document.getElementById('val-kwh').innerText = simTotalKwh;
            document.getElementById('val-total-cost').innerText = simTotalCost;
            document.getElementById('val-carbon').innerText = simCarbon;
            
            // Force update live gauges immediately to reflect sim
            updateLiveData(); 
        }

        async function fetchHistory() {
            if(isSimulation) return;
            try {
                const response = await fetch(`/api/history?period=${currentPeriod}`);
                const data = await response.json();
                if (data.data) {
                    myChart.data.labels = data.labels;
                    myChart.data.datasets[0].data = data.data;
                    myChart.data.datasets[0].borderColor = '#3b82f6'; 
                    myChart.data.datasets[0].backgroundColor = 'rgba(59, 130, 246, 0.5)';
                    myChart.update();
                }
                if(data.summary) {
                    document.getElementById('val-kwh').innerText = data.summary.total_kwh;
                    document.getElementById('val-total-cost').innerText = Number(data.summary.total_cost).toLocaleString('en-US', {minimumFractionDigits: 2});
                    document.getElementById('val-carbon').innerText = data.summary.total_carbon;
                }
            } catch (err) {}
        }

        async function updateLiveData() {
            // IF SIMULATION IS ACTIVE, GENERATE FAKE "LIVE" DATA HERE
            if(isSimulation) {
                // Generate voltage around 220
                const simVolt = (220 + Math.random() * 2 - 1).toFixed(1);
                
                // Generate power based on the Simulation Average (+/- noise)
                const simPower = (simAvgPower + (Math.random() * 50 - 25)).toFixed(1);
                
                // Calculate current
                const simCurrent = (simPower / simVolt).toFixed(2);
                
                // Calculate Rate
                const rate = parseFloat(document.getElementById('sim-rate').value) || 11.60;
                const simCost = ((simPower / 1000) * rate).toFixed(2);

                document.getElementById('val-voltage').innerText = simVolt;
                document.getElementById('val-current').innerText = simCurrent;
                document.getElementById('val-power').innerText = simPower;
                document.getElementById('val-live-cost').innerText = simCost;
                return; // Stop here, don't fetch from server
            }

            // OTHERWISE, FETCH REAL DATA
            try {
                const response = await fetch('/api/live');
                const data = await response.json();
                if(data.voltage) document.getElementById('val-voltage').innerText = data.voltage;
                if(data.current) document.getElementById('val-current').innerText = data.current;
                if(data.power) {
                    document.getElementById('val-power').innerText = data.power;
                    document.getElementById('val-live-cost').innerText = (data.power / 1000 * BASE_RATE).toFixed(2);
                }
            } catch (err) {}
        }

        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-300');
            });
            document.getElementById(`btn-${period}`).classList.remove('text-gray-300');
            document.getElementById(`btn-${period}`).classList.add('bg-blue-600', 'text-white');
            
            const titles = { 'today': "Today's Usage", 'weekly': "Weekly Trend", 'monthly': "Monthly Trend", 'yearly': "Yearly Trend" };
            document.getElementById('chart-title').innerText = titles[period];
            const labelMap = { 'today': "Today", 'weekly': "This Week", 'monthly': "This Month", 'yearly': "This Year" };
            document.getElementById('label-kwh').innerText = `Total Energy (${labelMap[period]})`;
            document.getElementById('label-cost').innerText = `Total Cost (${labelMap[period]})`;
            
            if(isSimulation) runSimulation(); else fetchHistory();
        }

        fetchHistory(); 
        setInterval(fetchHistory, 5000); 
        setInterval(updateLiveData, 2000);

    </script>
</body>
</html>
